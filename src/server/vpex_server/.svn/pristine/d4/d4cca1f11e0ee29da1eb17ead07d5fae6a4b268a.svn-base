package vpex_server::Index;
use Dancer2;
use utf8;
use LWP::UserAgent;
use DBI;
use JSON;
use strict;
use warnings;


use vars qw(%var);


get '/' => sub {
	
  template 'index', { 
     'VAR' => \%var,     
  };
  

}; ## /

post '/go' => sub {
  
  my $dbh = &vpex_server::Sub::connect_db(); 
  my $ua = LWP::UserAgent->new();
  $var{'ERROR'}=0;	
  debug "JSON_REQUEST: ".params->{'request'}.";";

  my %json_request=();
  my $data = from_json(params->{'request'});
  while (my ($key, $value) = each %{$data}) {
    $json_request{$key}=$value;
    debug "key: $key :: ".$json_request{$key}."; value: ".$value."\n";
  } # while
    
  $var{'ERROR'}=4041 if !$json_request{'username'}; 
  $var{'ERROR'}=4042 if !$json_request{'password'}; 
  $var{'ERROR'}=4043 if !$json_request{'photos_count'}; 
  
  my $sth = $dbh->prepare(q{ SELECT id FROM vpex_users WHERE username=? AND password=? });
  $sth->execute($json_request{'username'}, $json_request{'password'}) or debug " DB ERROR in login: ".$sth->errstr.";";
  ($var{'USER_ID'})=$sth->fetchrow_array();
  $sth->finish();
  
  $var{'ERROR'}=403 if !$var{'USER_ID'};
  
  debug "AUTH. ".$json_request{'username'}."; pw: ".$json_request{'password'}."; ph count: $json_request{'photos_count'}; USER_ID: $var{'USER_ID'}; ERROR: $var{'ERROR'};";
  
  if ($var{'ERROR'}==0)
  {
    
  } ## if ($var{'ERROR'}==0)
    
  template 'go', { 
     'VAR' => \%var,
     
  }, {layout => undef};
  

}; ## /



get '/search_vk_photos/:photos_count' => sub {

  my $ua = LWP::UserAgent->new();
  $var{'ERROR'}=0;	
 
  $var{'ERROR'}=404 if !params->{'photos_count'}; 
  
  if ($var{'ERROR'}==0)
  {
	debug " search_vk_photos: ".params->{'photos_count'}.";";
    my $vk_url='https://api.vk.com/method/photos.search?lat=56.850000&long=53.216667&count='.params->{'photos_count'}.'&radius=50000&sort=1&v=5.68';
    my $vk_response = $ua->get($vk_url); 
    my @vk_pics = ();                                
    if ( $vk_response->is_success() ) 
    {
      my $obj = $vk_response->content();
      debug "We`re get response DATA from vk!!! data: $obj;";
    
      ### Parse JSON object 
      my $dj = decode_json( $obj );

      eval {
        my $photo_count = $dj->{response}->{count};
        debug "VK PICS. photo_count: $photo_count;";
        my $i=0;
        while ($i<=25 && $photo_count>0) {
          $i++;
          my %row_data; 
          $row_data{ID} = $i;
          $row_data{ALBUM_ID} = $dj->{response}->{items}->[$i]->{album_id};
          $row_data{OWNER_ID} = $dj->{response}->{items}->[$i]->{owner_id};
          $row_data{LAT} = $dj->{response}->{items}->[$i]->{lat};
          $row_data{LONG} = $dj->{response}->{items}->[$i]->{long};
          $row_data{DATE} = $dj->{response}->{items}->[$i]->{date};
          $row_data{PHOTO_ID} = $dj->{response}->{items}->[$i]->{id};
          $row_data{SIZE_H} = $dj->{response}->{items}->[$i]->{height};
          $row_data{SIZE_W} = $dj->{response}->{items}->[$i]->{width};
          $row_data{POST_ID} = $dj->{response}->{items}->[$i]->{post_id};
          $row_data{TEXT} = $dj->{response}->{items}->[$i]->{text};
          $row_data{PHOTO_130} = $dj->{response}->{items}->[$i]->{photo_130};
          $row_data{PHOTO_604} = $dj->{response}->{items}->[$i]->{photo_604};
          debug "VK PICS; album_id: $row_data{ALBUM_ID}; photo_604: $row_data{PHOTO_604};";
          #$j++ if $album_id; 
          ## my $album_id = $dj->{response}->{items}->[0]->{album_id};
          ##print "album_id: $album_id; photo_604: $photo_604;\n";
          push(@vk_pics, \%row_data);
        } ## while
      }; ## eval
    
      eval { $var{'ERROR'}=$dj->{result}->{error};  debug " getted ERROR from JSON: $var{'ERROR'};";  }; ## eval
      #$var{'ERROR'}=0 if $var{'ERROR'}==200;
    } ## if ($vk_response->is_success()
    #else
    #{
#	my $obj = $vk_response->content();
#    debug "DEBUG. no response for auth data...; OBJ: $obj;";
#    my $dj = decode_json( $obj );
#   eval { $var{'ERROR'}=$dj->{result}->{error};  debug " getted ERROR from JSON: $var{'ERROR'};";  }; ## eval
# 	#$var{'ERROR'}=518;
   # }    
    
  }  
  template 'search_vk_photos', { 
     'VAR' => \%var,
     
  }, {layout => undef};
  

}; ## /






true;
