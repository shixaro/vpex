package vpex_server::Index;
use Dancer2;
use utf8;
use LWP::UserAgent;
use DBI;
use strict;
use warnings;


use vars qw(%var);


get '/' => sub {
	
  template 'index', { 
     'VAR' => \%var,     
  };
  

}; ## /

post '/go' => sub {
  
  my $dbh = &vpex_server::Sub::connect_db(); 
  $var{'ERROR'}=0;	
  debug "JSON_REQUEST: ".params->{'request'}.";";

  my %json_request=();
  my $data = from_json(params->{'request'});
  while (my ($key, $value) = each %{$data}) {
    $json_request{$key}=$value;
    debug "key: $key :: ".$json_request{$key}."; value: ".$value."\n";
  } # while
    
  $var{'ERROR'}=4041 if !params->{'username'}; 
  $var{'ERROR'}=4042 if !params->{'password'}; 
  
  my $sth = $dbh->prepare(q{ SELECT id FROM vpex_users WHERE username=? AND password=? });
  $sth->execute($json_request{'username'}, $json_request{'password'}) or debug " DB ERROR in login: ".$sth->errstr.";";
  ($var{'USER_ID'})=$sth->fetchrow_array();
  $sth->finish();
  
  $var{'ERROR'}=403 if !$var{'USER_ID'};
  
  debug "AUTH. ".params->{'username'}."; pw: ".params->{'password'}."; USER_ID: $var{'USER_ID'}; ERROR: $var{'ERROR'};";
  
  if ($var{'ERROR'}==0)
  {
    $var{'VK_CLIENT_ID'} = 6269486;
    $var{'VK_SECRET'} = 'phL1ewpxwb2nZaFSBEDI';
    $var{'VK_SERVICE_KEY'} = 'dbd24a0adbd24a0adbd24a0a32db8de024ddbd2dbd24a0a81c7cb08b3c69a8cc9824b16';
    $var{'VK_CALLBACK'} = 'http://localhost:3000';
  
    $var{'OAUTH_URL'}='https://oauth.vk.com/access_token?client_id='.$var{'VK_CLIENT_ID'}.'&client_secret='.$var{'VK_SECRET'}.'&code='.$var{'OAUTH_CODE'}.'&redirect_uri='.$var{'VK_CALLBACK'};
    
    debug "I`m IN. OAUTH_URL: $var{'OAUTH_URL'}";
  }  
  template 'go', { 
     'VAR' => \%var,
     
  }, {layout => undef};
  

}; ## /






true;
